From eb58e902c902a39a0a248893a44ac5e2c9a7a1d7 Mon Sep 17 00:00:00 2001
From: LinsaFTW <25271111+linsaftw@users.noreply.github.com>
Date: Mon, 21 Jun 2021 03:29:33 -0300
Subject: [PATCH] Limit ChatComponents


diff --git a/src/main/java/net/minecraft/server/IChatBaseComponent.java b/src/main/java/net/minecraft/server/IChatBaseComponent.java
index 463cfe49f..52743978c 100644
--- a/src/main/java/net/minecraft/server/IChatBaseComponent.java
+++ b/src/main/java/net/minecraft/server/IChatBaseComponent.java
@@ -46,11 +46,25 @@ public interface IChatBaseComponent extends Iterable<IChatBaseComponent> {
             } else if (!jsonelement.isJsonObject()) {
                 if (jsonelement.isJsonArray()) {
                     JsonArray jsonarray = jsonelement.getAsJsonArray();
+
+                    // FlamePaper start - Limit ChatComponents
+                    if (jsonarray.size() > 16) {
+                        throw new JsonParseException("Too many ChatComponent array elements");
+                    }
+                    // FlamePaper end - Limit Chatcomponents
+
                     IChatBaseComponent ichatbasecomponent = null;
                     Iterator iterator = jsonarray.iterator();
 
                     while (iterator.hasNext()) {
                         JsonElement jsonelement1 = (JsonElement) iterator.next();
+
+                        // FlamePaper start - Limit ChatComponents
+                        if (jsonelement.isJsonArray()) {
+                            throw new JsonParseException("Stacked ChatComponent array");
+                        }
+                        // FlamePaper end - Limit Chatcomponents
+
                         IChatBaseComponent ichatbasecomponent1 = this.a(jsonelement1, (Type) jsonelement1.getClass(), jsondeserializationcontext);
 
                         if (ichatbasecomponent == null) {
@@ -75,9 +89,28 @@ public interface IChatBaseComponent extends Iterable<IChatBaseComponent> {
 
                     if (jsonobject.has("with")) {
                         JsonArray jsonarray1 = jsonobject.getAsJsonArray("with");
+
+                        // FlamePaper start - Limit ChatComponents
+                        if (jsonarray1.size() > 16) {
+                            throw new JsonParseException("Too many ChatComponent array elements in with");
+                        }
+                        // FlamePaper end - Limit Chatcomponents
+
+                        // FlamePaper start - Limit ChatComponents
+                        if (lastElement != null && lastElement.equals("with")) {
+                            throw new JsonParseException("Stacked with ChatComponent element");
+                        }
+                        // FlamePaper end - Limit Chatcomponents
+
                         Object[] aobject = new Object[jsonarray1.size()];
 
                         for (int i = 0; i < aobject.length; ++i) {
+                            // FlamePaper start - Limit ChatComponents
+                            if (jsonarray1.get(i).isJsonArray()) {
+                                throw new JsonParseException("Stacked ChatComponent array in with element");
+                            }
+                            // FlamePaper end - Limit Chatcomponents
+                            
                             aobject[i] = this.a("with", jsonarray1.get(i), type, jsondeserializationcontext);
                             if (aobject[i] instanceof ChatComponentText) {
                                 ChatComponentText chatcomponenttext = (ChatComponentText) aobject[i];
@@ -114,11 +147,29 @@ public interface IChatBaseComponent extends Iterable<IChatBaseComponent> {
                 if (jsonobject.has("extra")) {
                     JsonArray jsonarray2 = jsonobject.getAsJsonArray("extra");
 
+                    // FlamePaper start - Limit ChatComponents
+                    if (jsonarray2.size() > 16) {
+                        throw new JsonParseException("Too many ChatComponent array elements in extra");
+                    }
+                    // FlamePaper end - Limit Chatcomponents
+
+                    // FlamePaper start - Limit ChatComponents
+                    if (lastElement != null && lastElement.equals("extra")) {
+                        throw new JsonParseException("Stacked extra ChatComponent element");
+                    }
+                    // FlamePaper end - Limit Chatcomponents
+
                     if (jsonarray2.size() <= 0) {
                         throw new JsonParseException("Unexpected empty array of components");
                     }
 
                     for (int j = 0; j < jsonarray2.size(); ++j) {
+                        // FlamePaper start - Limit ChatComponents
+                        if (jsonarray2.get(j).isJsonArray()) {
+                            throw new JsonParseException("Stacked ChatComponent array in extra element");
+                        }
+                        // FlamePaper end - Limit Chatcomponents
+
                         ((IChatBaseComponent) object).addSibling(this.a("extra", jsonarray2.get(j), type, jsondeserializationcontext));
                     }
                 }
-- 
2.32.0

