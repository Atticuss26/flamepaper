From 3bbc9f8164608310c7b43dd9e5d41a0fc79b2aba Mon Sep 17 00:00:00 2001
From: LinsaFTW <25271111+linsaftw@users.noreply.github.com>
Date: Thu, 24 Mar 2022 04:20:38 -0300
Subject: [PATCH] Hopper item lookup optimization


diff --git a/src/main/java/net/minecraft/server/Chunk.java b/src/main/java/net/minecraft/server/Chunk.java
index ab0d41cad..932742dd6 100644
--- a/src/main/java/net/minecraft/server/Chunk.java
+++ b/src/main/java/net/minecraft/server/Chunk.java
@@ -746,6 +746,7 @@ public class Chunk {
         // PaperSpigot start - update counts
         if (entity instanceof EntityItem) {
             itemCounts[k]++;
+            itemCount++; // FlamePaper - Hopper item lookup optimization
         } else if (entity instanceof IInventory) {
             inventoryEntityCounts[k]++;
         }
@@ -785,6 +786,7 @@ public class Chunk {
         // PaperSpigot start - update counts
         if (entity instanceof EntityItem) {
             itemCounts[i]--;
+            itemCount--; // FlamePaper - Hopper item lookup optimization
         } else if (entity instanceof IInventory) {
             inventoryEntityCounts[i]--;
         }
@@ -1487,4 +1489,12 @@ public class Chunk {
 
         private EnumTileEntityState() {}
     }
+
+    // FlamePaper start - Hopper item lookup optimization
+    private int itemCount = 0;
+
+    public int getItemCount() {
+        return itemCount;
+    }
+    // FlamePaper end - Hopper item lookup optimization
 }
diff --git a/src/main/java/net/minecraft/server/TileEntityHopper.java b/src/main/java/net/minecraft/server/TileEntityHopper.java
index 457ee7cbd..539b5f336 100644
--- a/src/main/java/net/minecraft/server/TileEntityHopper.java
+++ b/src/main/java/net/minecraft/server/TileEntityHopper.java
@@ -613,7 +613,9 @@ public class TileEntityHopper extends TileEntityContainer implements IHopper, IU
             }
         }
 
-        if (object == null && !org.bukkit.craftbukkit.util.CraftMagicNumbers.getMaterial(block).isOccluding()) {
+        net.minecraft.server.Chunk chunk = world.getChunkAtWorldCoords(blockposition);
+
+        if (object == null && !org.bukkit.craftbukkit.util.CraftMagicNumbers.getMaterial(block).isOccluding() && chunk.getItemCount() > 0) {
             List list = world.a((Entity) null, new AxisAlignedBB(d0 - 0.5D, d1 - 0.5D, d2 - 0.5D, d0 + 0.5D, d1 + 0.5D, d2 + 0.5D), IEntitySelector.c);
 
             if (list.size() > 0) {
-- 
2.32.0

